---
- name: Fetch RKE2 Kubeconfig
  hosts: masters
  become: yes
  tasks:
    - name: Fetch kubeconfig from first control plane node
      run_once: yes
      fetch:
        src: /etc/rancher/rke2/rke2.yaml
        dest: /tmp/rke2.yaml
        flat: yes

    - name: Replace localhost with control plane IP
      delegate_to: localhost
      become: no
      replace:
        path: /tmp/rke2.yaml
        regexp: "127.0.0.1"
        replace: "{{ hostvars[groups['masters']|first]['ansible_host'] }}"

    - name: Ensure .kube directory exists on localhost
      delegate_to: localhost
      become: no
      file:
        path: ~/.kube
        state: directory
        mode: "0700"

    - name: Move kubeconfig to ~/.kube/config
      delegate_to: localhost
      become: no
      copy:
        src: /tmp/rke2.yaml
        dest: ~/.kube/config
        remote_src: yes
        mode: "0600"

    - name: Print success message
      delegate_to: localhost
      debug:
        msg: "Kubeconfig has been copied to ~/.kube/config. Run 'kubectl get nodes' to verify."
